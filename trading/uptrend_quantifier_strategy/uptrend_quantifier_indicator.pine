//@version=5
strategy("单边上涨趋势量化策略 (Uptrend Quantifier Strategy)", 
         shorttitle="上涨量化策略", 
         overlay=true, 
         initial_capital=10000, 
         default_qty_type=strategy.percent_of_equity, 
         default_qty_value=100, 
         commission_type=strategy.commission.percent, 
         commission_value=0.1)

// =================================================================================
// 1. 用户输入 (User Inputs)
// =================================================================================
ma_group = "移动平均线 (Moving Averages)"
len_short = input.int(20, title="短期MA", group=ma_group, tooltip="用于判断短期趋势和价格位置。推荐使用EMA。")
len_mid = input.int(50, title="中期MA", group=ma_group, tooltip="中期趋势的关键均线，常作为牛熊分界参考。")
len_long = input.int(200, title="长期MA", group=ma_group, tooltip="长期趋势的关键均线，黄金交叉/死亡交叉的组成部分。")

adx_group = "ADX趋势强度 (Trend Strength)"
adx_len = input.int(14, title="ADX/DMI 周期", group=adx_group)
adx_threshold = input.int(25, title="ADX 趋势强度阈值", group=adx_group, tooltip="ADX高于此值表示市场存在明确趋势。")

visual_group = "视觉呈现 (Visualization)"
show_mas = input.bool(true, title="显示移动平均线", group=visual_group)
show_bg_color = input.bool(true, title="显示背景高亮", group=visual_group)
show_dashboard = input.bool(true, title="显示状态面板", group=visual_group)

// =================================================================================
// 2. 指标计算 (Indicator Calculations)
// =================================================================================
// 计算移动平均线 (使用EMA，对价格变化更敏感)
ema_short = ta.ema(close, len_short)
ema_mid = ta.ema(close, len_mid)
ema_long = ta.ema(close, len_long)

// 计算ADX和DMI
[di_plus, di_minus, adx] = ta.dmi(adx_len, adx_len)

// =================================================================================
// 3. 定义上涨趋势的量化条件 (Defining Uptrend Conditions)
// =================================================================================

// 条件1: 市场结构 - 均线多头排列 (MA bullish alignment)
// 短期 > 中期 > 长期。这是一个非常严格的上涨趋势结构。
cond_ma_structure = ema_short > ema_mid and ema_mid > ema_long

// 条件2: 价格位置 - 收盘价在中期均线上方 (Price position)
cond_price_position = close > ema_mid

// 条件3: 趋势强度 - ADX高于阈值 (Trend strength)
cond_trend_strength = adx > adx_threshold

// 条件4: 趋势方向 - 上升方向线高于下降方向线 (Trend direction)
cond_trend_direction = di_plus > di_minus

// 综合所有条件，判断是否为“单边上涨趋势”
is_strong_uptrend = cond_ma_structure and cond_price_position and cond_trend_strength and cond_trend_direction

// =================================================================================
// 4. 策略逻辑 (Strategy Logic)
// =================================================================================

// 入场条件: 单边上涨趋势首次确立的K线
long_entry_condition = is_strong_uptrend and not is_strong_uptrend[1]

// !! 优化后的出场条件: 价格收盘价下穿中期均线 !!
long_exit_condition = ta.crossunder(close, ema_mid)

// 执行交易
if (long_entry_condition)
    strategy.entry("开多", strategy.long)

if (long_exit_condition)
    strategy.close("开多", comment="平多-跌破中期线")

// =================================================================================
// 5. 视觉化呈现 (Visualization)
// =================================================================================

// 绘制移动平均线
plot(show_mas ? ema_short : na, "短期EMA", color=color.new(color.teal, 0), linewidth=2)
plot(show_mas ? ema_mid : na, "中期EMA", color=color.new(color.orange, 0), linewidth=2)
plot(show_mas ? ema_long : na, "长期EMA", color=color.new(color.red, 0), linewidth=3)

// 根据是否满足上涨条件，改变背景颜色
bgcolor(show_bg_color and is_strong_uptrend ? color.new(color.green, 85) : na)

// 创建一个状态显示面板
var table g_dashboard = table.new(position.top_right, 2, 6, bgcolor = color.new(color.gray, 20), border_width = 1)

if (show_dashboard and barstate.islast)
    // --- 表头 ---
    table.cell(g_dashboard, 0, 0, "分析项", text_color=color.white, bgcolor=color.black, text_halign=text.align_center)
    table.cell(g_dashboard, 1, 0, "状态", text_color=color.white, bgcolor=color.black, text_halign=text.align_center)
    
    // --- 1. 市场结构 ---
    table.cell(g_dashboard, 0, 1, "市场结构 (均线排列)", text_color=color.white)
    table.cell(g_dashboard, 1, 1, cond_ma_structure ? "✅ 多头" : "❌ 非多头", bgcolor=cond_ma_structure ? color.new(color.green, 20) : color.new(color.red, 20), text_halign=text.align_center)
    
    // --- 2. 价格位置 ---
    table.cell(g_dashboard, 0, 2, "价格位置 (>"+str.tostring(len_mid)+"EMA)", text_color=color.white)
    table.cell(g_dashboard, 1, 2, cond_price_position ? "✅ 线上" : "❌ 线下", bgcolor=cond_price_position ? color.new(color.green, 20) : color.new(color.red, 20), text_halign=text.align_center)
    
    // --- 3. 趋势强度 ---
    table.cell(g_dashboard, 0, 3, "趋势强度 (ADX > "+str.tostring(adx_threshold)+")", text_color=color.white)
    table.cell(g_dashboard, 1, 3, cond_trend_strength ? "✅ 趋势" : "❌ 震荡", bgcolor=cond_trend_strength ? color.new(color.green, 20) : color.new(color.red, 20), text_halign=text.align_center)

    // --- 4. 趋势方向 ---
    table.cell(g_dashboard, 0, 4, "趋势方向 (+DI > -DI)", text_color=color.white)
    table.cell(g_dashboard, 1, 4, cond_trend_direction ? "✅ 向上" : "❌ 向下", bgcolor=cond_trend_direction ? color.new(color.green, 20) : color.new(color.red, 20), text_halign=text.align_center)

    // --- 5. 综合结论 ---
    table.cell(g_dashboard, 0, 5, "综合结论", text_color=color.white, text_size=size.normal)
    table.cell(g_dashboard, 1, 5, is_strong_uptrend ? "强劲单边上涨" : "非单边上涨", bgcolor=is_strong_uptrend ? color.green : color.red, text_color=color.white, text_size=size.normal, text_halign=text.align_center) 